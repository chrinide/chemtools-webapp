{% extends "chem/base.html" %}

{% block title %}{{ pagename }}{% endblock %}

{% block header %}
{{ block.super }}
<script>
{% autoescape on %}
function submitForm(name) {
    $("form input#id_molname").val(name);
    $("form#newform").submit();
}

$(function() {
    $("#id_post").click(function() {
        event.preventDefault();
        var a = $('#newform').serialize();
        $.post('', a, function(data) {
            if (data["error"] != undefined) {
                var text = data["error"];
            }
            else {
                var text = '<ul>Worked:';
                for (var i = 0; i < data["worked"].length; i++) {
                    var name = data["worked"][i][0];
                    var id = data["worked"][i][1];
                    text += "<li>{0} -- <a href='/chem/jobs/{1}'>{1}</a></li>".format(name, id);
                }
                text += "</ul>";
                if (data["failed"].length > 0) {
                    text += "<ul>Failed:";
                    for (var i = 0; i < data["failed"].length; i++) {
                        text += "<li>{0} -- {1}</li>".format(data["failed"][i][0], data["failed"][i][1]);
                    }
                    text += "</ul>"
                }
            }

            var newdialog = $('<div id="id_results">{0}</div>'.format(text));
            newdialog.dialog({
                modal: true,
                title: "Results",
                });
            },
            'json'
            );
        }
    );

    $("#id_zip_download").click(function() {
        event.preventDefault();
        var a = $('#headerform').serialize();
        if ($('#id_job').val() === 'on'){
            a += '&' + $('#newform').serialize()
        }
        window.location = "/chem/{{ pagename }}.zip?{0}".format(a);
    })

    $.getJSON('check/', function(data) {
        var table = $("table.centered");
        var text = '';
        for (var i=0; i < data.molecules.length; i++) {
            var name = data.molecules[i][0];
            var warning = data.molecules[i][1];
            var error = data.molecules[i][2];
            var message = '';
            if (error) message = 'id="error"';
            else if (warning) message = 'id="warning"';

            text += '<tr {0}>'.format(message);
            text += '<td><a href="../{0}/">{0}</a></td>'.format(name);

            if (!(error)) {
                text += '<td><a href="../{0}.gjf{{ encoded_basis }}">gjf</a></td>'.format(name);
                text += '<td><a href="../{0}.mol2{{ encoded_basis }}">mol2</a></td>'.format(name);
                text += '<td><a href="../{0}.png{{ encoded_basis }}">Image</a></td>'.format(name);
                text += '<td><a href="#" onClick="submitForm(\'{0}\')">Job</a></td>'.format(name);
            }
            else {
                text += '<td colspan="4">{0}</td>'.format(error);
            }
            text += '<td><a href="../{0}/report/">Report</a></td>'.format(name);
            text += '</tr>';
        }
        table.append(text);
    })
});


{% endautoescape %}
</script>
{% endblock %}

{% block content %}
    {% if error %}
        <h1>{{ error }}</h1>
    {% else %}
    <h1>{{ pagename }}</h1>
    <table class="centered">
        <tr>
            <form id="headerform">
            <th>Name</th>
            <th>
                <input type="checkbox" id="id_gjf" name="gjf" {{ gjf }}/>
                <label for="id_gjf">gjf</label>
            </th>
            <th>
                <input type="checkbox" id="id_mol2" name="mol2" {{ mol2 }}/>
                <label for="id_mol2">mol2</label>
            </th>
            <th><input type="checkbox" id="id_image" name="image" {{ image }}/>
                <label for="id_image">Image</label>
            </th>
            <th>
                <input type="checkbox" id="id_job" name="job" {{ job }}/>
                <label for="id_job">Job</label>
            </th>
            <th></th>
            </form>
        </tr>
    </table>
    <div class="hide-container">
    <div class="hide-title">
        <a href="#">Job Form</a>
    </div>
    <div class="hide">
        <form id="newform" action="." method="get">
            <table>
                {{ form.as_table }}
            </table>
            {% if basis %}<input type="hidden" name="basis" value="{{ basis }}">{% endif %}
            <input type="hidden" id="id_molname" name="molname" value="">
            <table>
                <tr><th>
                    {% if user.is_authenticated %}
                        {% csrf_token %}
                        <input type="submit" value="Submit Job" id="id_post"/>
                    {% endif %}
                    <input type="reset" value="Reset" />
                </th></tr>
            </table>
        </form>
    </div>
    </div>
    <a href='../{{ pagename }}.zip' id="id_zip_download">Download All</a>
    {% endif %}
{% endblock %}