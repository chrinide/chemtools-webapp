{% extends "chem/base.html" %}
{% load bootstrap %}

{% block title %}Multi Job{% endblock %}

{% block script %}
<script>
{% autoescape on %}

$(function() {
    $("#id_myfiles").change( function () {
        var files = $(this).prop('files');
        var textarea = $("textarea[name='filenames']");
        var names = ''
        $(files).each( function (i, elem) {
            names += '\n' + elem.name;
        });
        if (textarea.val() !== '') {
            textarea.val(textarea.val()+names);
        } else {
            textarea.val(names.slice(1));
        }
    });
    $("#id_post").click(function() {
        event.preventDefault();
        var a = new FormData($("#main")[0]);
        var files = $("input[name='myfiles']").prop('files');
        for(var x=0;x<files.length;x++) {
            a.append("files", files[x]);
        }

        $.ajax({
            url: '',
            data: a,
            processData: false,
            contentType: false,
            type: 'POST',
            success: function(data) {
                if (data["error"] != undefined) {
                    var text = data["error"];
                }
                else {

                    var text = "<h3>{0}</h3>".format(data["cluster"]);
                    text += '<div class="panel panel-success">'
                    text += '<div class="panel-heading"><h3 class="panel-title">{0}</h3></div>'.format("Worked")

                    text += '<div class="panel-body">';
                    for (var i = 0; i < data["worked"].length; i++) {
                        var name = data["worked"][i][0];
                        var id = data["worked"][i][1];
                        text += "<a class='list-group-item' href='/chem/jobs/{2}/{1}'>{0} &mdash; {1}</a>".format(name, id, data["cluster"]);
                    }
                    text += "</div></div>";

                    if (data["failed"].length > 0) {
                        text += '<div class="panel panel-danger">';
                        text += '<div class="panel-heading"><h3 class="panel-title">{0}</h3></div>'.format("Failed")
                        text += '<div class="panel-body">';
                        var mols = [];
                        for (var i = 0; i < data["failed"].length; i++) {
                            text += "<li class='list-group-item'>{0} &mdash; {1}</li>".format(data["failed"][i][0], data["failed"][i][1]);
                            mols.push(data["failed"][i][0]);
                        }
                        text += "</div></div>";
                    }
                }
                text += "<br><a href='/chem/jobs/'>Go to jobs list.</a>";
                var dialog = $("#resultsModal .modal-body");
                dialog.html(text);
                var newdialog = $('<div id="id_results">{0}</div>'.format(text));
                $('#resultsModal').modal();
            }
        });
    });
});


{% endautoescape %}
</script>
{% endblock %}

{% block content %}
    <p>
        Filenames can be separated by newlines or by commas. File extensions do not matter because they will be stripped off before the job file is made. This method also allows generating jobs using brace expansions as seen in the <a href="{% url docs %}#brace-expansion">docs</a>.
    </p>
    {% if error_message %}
        <p><strong>{{ error_message }}</strong></p>
    {% endif %}
    <form enctype="multipart/form-data">
        <div class="form-group">
            <label class="control-label" for="id_myfiles">Upload Files</label>
            <input type="file" id="id_myfiles" name="myfiles" multiple />
        </div>
    </form>
    <form id="main" enctype="multipart/form-data" action="." method="get">
        {% csrf_token %}
        <div class="form-group">
            <label class="control-label" for="id_filenames">Filenames</label>
            <div class="">
                <textarea id="id_filenames" rows="26" cols="50" name="filenames" class=" form-control"></textarea>
            </div>
        </div>
        {{ form|bootstrap }}
        <div class="row">
            <div class="col-xs-4">
                <button class="btn btn-lg btn-primary btn-block" type="submit">Build!</button>
            </div>
            {% if user.is_authenticated %}
            <div class="col-xs-4">
                <button id="id_post" class="btn btn-lg btn-primary btn-block">Submit!</button>
            </div>
            {% endif %}
            <div class="col-xs-4">
                <button class="btn btn-lg btn-block" type="reset">Reset</button>
            </div>
        </div>
    </form>

<div class="modal fade" id="resultsModal" tabindex="-1" role="dialog" aria-labelledby="resultsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Results</h4>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}